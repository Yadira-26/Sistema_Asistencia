{% extends "base.html" %}

{% block title %}Reportes - Sistema de Asistencia QR{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-bar"></i> Reportes de Asistencia
        </h1>
    </div>
</div>

{# Mostrar formularios solo si no se está mostrando un reporte diario, de período, individual o general #}
{% if not report_title or (report_title and 'Reporte Diario' not in report_title and 'Reporte de Período' not in report_title and 'Individual' not in report_title and 'Reporte General' not in report_title) %}
<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card shadow border-0">
            <div class="card-header bg-primary text-white rounded-top">
                <h5 class="mb-0"><i class="fas fa-calendar-day"></i> Reporte Diario</h5>
            </div>
            <div class="card-body bg-light rounded-bottom">
                <form action="{{ url_for('daily_report') }}" method="POST">
                    <div class="form-group">
                        <label for="report_date">Fecha:</label>
                        <input type="date" class="form-control" id="report_date" name="report_date" value="{{ today }}" required>
                    </div>
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-file-alt"></i> Generar Reporte Diario
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow border-0">
            <div class="card-header bg-success text-white rounded-top">
                <h5 class="mb-0"><i class="fas fa-calendar-week"></i> Reporte por Período</h5>
            </div>
            <div class="card-body bg-light rounded-bottom">
                <form action="{{ url_for('period_report') }}" method="POST">
                    <div class="form-group">
                        <label for="start_date">Fecha Inicio:</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" value="{{ week_ago }}" required>
                    </div>
                    <div class="form-group">
                        <label for="end_date">Fecha Fin:</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" value="{{ today }}" required>
                    </div>
                    <button type="submit" class="btn btn-success btn-block">
                        <i class="fas fa-chart-line"></i> Generar Reporte de Período
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6 mb-4">
        <div class="card shadow border-0">
            <div class="card-header bg-info text-white rounded-top">
                <h5 class="mb-0"><i class="fas fa-user"></i> Reporte Individual</h5>
            </div>
            <div class="card-body bg-light rounded-bottom">
                <form action="{{ url_for('employee_report') }}" method="POST">
                    <div class="form-group">
                        <label for="employee_id">Empleado:</label>
                        <select class="form-control" id="employee_id" name="employee_id" required>
                            <option value="">Seleccione un empleado</option>
                            {% for employee in employees %}
                            <option value="{{ employee.employee_id }}">{{ employee.full_name }} ({{ employee.employee_id }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="start_date_individual">Fecha Inicio:</label>
                        <input type="date" class="form-control" id="start_date_individual" name="start_date" value="{{ week_ago }}" required>
                    </div>
                    <div class="form-group">
                        <label for="end_date_individual">Fecha Fin:</label>
                        <input type="date" class="form-control" id="end_date_individual" name="end_date" value="{{ today }}" required>
                    </div>
                    <button type="submit" class="btn btn-info btn-block">
                        <i class="fas fa-search"></i> Generar Reporte Individual
                    </button>
                </form>
            </div>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card shadow border-0">
            <div class="card-header bg-warning text-dark rounded-top">
                <h5 class="mb-0"><i class="fas fa-file-alt"></i> Reporte General</h5>
            </div>
            <div class="card-body bg-light rounded-bottom">
                <form action="{{ url_for('general_report') }}" method="POST">
                    <div class="form-group">
                        <label for="start_date_general">Fecha Inicio:</label>
                        <input type="date" class="form-control" id="start_date_general" name="start_date" value="{{ week_ago }}" required>
                    </div>
                    <div class="form-group">
                        <label for="end_date_general">Fecha Fin:</label>
                        <input type="date" class="form-control" id="end_date_general" name="end_date" value="{{ today }}" required>
                    </div>
                    <button type="submit" class="btn btn-warning btn-block">
                        <i class="fas fa-clipboard-list"></i> Generar Reporte General
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endif %}

{# Mostrar solo la tabla en el reporte diario, individual o general #}
{% if report_title and ('Reporte Diario' in report_title or 'Individual' in report_title or 'Reporte General' in report_title) %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <a href="{{ url_for('reports') }}" class="btn btn-link text-primary mr-2" title="Volver a reportes">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h5 class="mb-0 mr-auto"><i class="fas fa-table"></i> {{ report_title }}</h5>
                {% if report_data is not none and not report_data.empty %}
                <form action="{{ url_for('export_pdf') }}" method="post" class="d-inline-block ml-2">
                    <input type="hidden" name="report_title" value="{{ report_title }}">
                    <input type="hidden" name="start_date" value="{{ start_date }}">
                    <input type="hidden" name="end_date" value="{{ end_date }}">
                    {% if employee_id %}<input type="hidden" name="employee_id" value="{{ employee_id }}">{% endif %}
                    <button type="submit" class="btn btn-sm btn-danger" title="Descargar PDF">
                        <i class="fas fa-file-pdf"></i> Descargar PDF
                    </button>
                </form>
                <form action="{{ url_for('export_excel') }}" method="post" class="d-inline-block ml-1">
                    <input type="hidden" name="report_title" value="{{ report_title }}">
                    <input type="hidden" name="start_date" value="{{ start_date }}">
                    <input type="hidden" name="end_date" value="{{ end_date }}">
                    {% if employee_id %}<input type="hidden" name="employee_id" value="{{ employee_id }}">{% endif %}
                    <button type="submit" class="btn btn-sm btn-success" title="Descargar Excel">
                        <i class="fas fa-file-excel"></i> Descargar Excel
                    </button>
                </form>
                {% endif %}
            </div>
            <div class="card-body">
                {% if report_data is not none and not report_data.empty %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                {% for column in report_data.columns %}
                                {% if column != 'attendance_id' %}
                                <th>{{ column }}</th>
                                {% endif %}
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for _, row in report_data.iterrows() %}
                            <tr>
                            {% for idx, value in row.items() %}
                                {% if (idx == 'Entrada' or idx == 'Salida') and session.admin_user_id and report_title and ('Reporte Diario' in report_title or 'Individual' in report_title or 'Reporte General' in report_title) and value != 'No registrada' %}
                                <td>
                                    <input type="time" 
                                           class="form-control form-control-sm time-edit" 
                                           data-attendance-id="{{ row['attendance_id'] }}" 
                                           data-field="{{ idx.lower() }}"
                                           value="{{ value }}" 
                                           style="width: 120px; border: 1px solid #28a745;"
                                           title="Clic para editar la hora">
                                </td>
                                {% elif idx != 'attendance_id' %}
                                <td>{{ value }}</td>
                                {% endif %}
                            {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    No hay datos disponibles para el período seleccionado.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{# Mostrar solo los gráficos en el reporte de período #}
{% if report_title and 'Reporte de Período' in report_title and charts %}
<div class="row mt-4">
    <div class="col-md-12 mb-3">
        <div class="d-flex align-items-center">
            <a href="{{ url_for('reports') }}" class="btn btn-link text-primary mr-2" title="Volver a reportes">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h5 class="mb-0"><i class="fas fa-chart-bar"></i> {{ report_title }}</h5>
        </div>
    </div>
    {% for chart in charts %}
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6>{{ chart.title }}</h6>
            </div>
            <div class="card-body text-center">
                <img src="data:image/png;base64,{{ chart.data }}" class="img-fluid" alt="{{ chart.title }}">
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Solo ejecutar si hay campos de tiempo editables
    const timeEdits = document.querySelectorAll('.time-edit');
    
    if (timeEdits.length === 0) {
        console.log('No hay campos de tiempo editables en esta página');
        return;
    }
    
    timeEdits.forEach(function(input) {
        let originalValue = input.value;
        
        input.addEventListener('focus', function() {
            originalValue = this.value;
        });
        
        input.addEventListener('change', function() {
            const attendanceId = this.getAttribute('data-attendance-id');
            const field = this.getAttribute('data-field');
            const newTime = this.value;
            
            if (newTime === originalValue) {
                return; // No hay cambios
            }
            
            // Validar formato de tiempo
            if (!newTime.match(/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/)) {
                showNotification('Formato de hora inválido. Use HH:MM', 'danger');
                this.value = originalValue;
                return;
            }
            
            // Convertir a formato HH:MM:SS
            const timeWithSeconds = newTime + ':00';
            
            // Mostrar indicador de carga
            this.style.opacity = '0.5';
            this.disabled = true;
            
            fetch('/update_attendance_time', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    attendance_id: attendanceId,
                    new_time: timeWithSeconds,
                    csrf_token: '{{ csrf_token }}'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showNotification(`Hora de ${field} actualizada correctamente`, 'success');
                    originalValue = newTime;
                    // Actualizar visualmente
                    this.style.borderColor = '#28a745';
                } else {
                    // Revertir el cambio si hay error
                    this.value = originalValue;
                    showNotification('Error al actualizar: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                // Revertir el cambio si hay error
                this.value = originalValue;
                showNotification('Error de conexión', 'danger');
            })
            .finally(() => {
                // Restaurar el input
                this.style.opacity = '1';
                this.disabled = false;
            });
        });
    });
    
    console.log(`Sistema de edición de horas cargado: ${timeEdits.length} campos editables encontrados`);
});

function showNotification(message, type) {
    // Crear o actualizar la notificación
    let notification = document.getElementById('admin-notification');
    if (!notification) {
        notification = document.createElement('div');
        notification.id = 'admin-notification';
        notification.style.position = 'fixed';
        notification.style.top = '20px';
        notification.style.right = '20px';
        notification.style.zIndex = '9999';
        notification.style.minWidth = '300px';
        document.body.appendChild(notification);
    }
    
    notification.className = `alert alert-${type} alert-dismissible fade show`;
    notification.innerHTML = `
        <strong>${type === 'success' ? '✅ Éxito!' : '❌ Error!'}</strong> ${message}
        <button type="button" class="close" data-dismiss="alert">
            <span>&times;</span>
        </button>
    `;
    
    // Auto-dismiss después de 4 segundos
    setTimeout(() => {
        if (notification && notification.parentNode) {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification && notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 150);
        }
    }, 4000);
}
</script>
{% endblock %}
