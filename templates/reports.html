{% extends "base.html" %}

{% block title %}Reportes - Sistema de Asistencia QR{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">
            <i class="fas fa-chart-bar"></i> Reportes de Asistencia
        </h1>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-day"></i> Reporte Diario</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('daily_report') }}" method="POST">
                    <div class="form-group">
                        <label for="report_date">Fecha:</label>
                        <input type="date" class="form-control" id="report_date" name="report_date" 
                               value="{{ today }}" required>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-file-alt"></i> Generar Reporte Diario
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-week"></i> Reporte por Período</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('period_report') }}" method="POST">
                    <div class="form-group">
                        <label for="start_date">Fecha Inicio:</label>
                        <input type="date" class="form-control" id="start_date" name="start_date" 
                               value="{{ week_ago }}" required>
                    </div>
                    <div class="form-group">
                        <label for="end_date">Fecha Fin:</label>
                        <input type="date" class="form-control" id="end_date" name="end_date" 
                               value="{{ today }}" required>
                    </div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-chart-line"></i> Generar Reporte de Período
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-user"></i> Reporte por Empleado</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('employee_report') }}" method="POST">
                    <div class="form-group">
                        <label for="employee_select">Empleado:</label>
                        <select class="form-control" id="employee_select" name="employee_id" required>
                            <option value="">Seleccione un empleado</option>
                            {% for employee in employees %}
                            <option value="{{ employee.employee_id }}">
                                {{ employee.employee_id }} - {{ employee.full_name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="emp_start_date">Fecha Inicio:</label>
                        <input type="date" class="form-control" id="emp_start_date" name="start_date" 
                               value="{{ week_ago }}" required>
                    </div>
                    <div class="form-group">
                        <label for="emp_end_date">Fecha Fin:</label>
                        <input type="date" class="form-control" id="emp_end_date" name="end_date" 
                               value="{{ today }}" required>
                    </div>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-user-clock"></i> Generar Reporte Individual
                    </button>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-file-pdf"></i> Exportar PDF</h5>
            </div>
            <div class="card-body">
                <form action="{{ url_for('export_pdf') }}" method="POST">
                    <div class="form-group">
                        <label for="pdf_start_date">Fecha Inicio:</label>
                        <input type="date" class="form-control" id="pdf_start_date" name="start_date" 
                               value="{{ week_ago }}" required>
                    </div>
                    <div class="form-group">
                        <label for="pdf_end_date">Fecha Fin:</label>
                        <input type="date" class="form-control" id="pdf_end_date" name="end_date" 
                               value="{{ today }}" required>
                    </div>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-download"></i> Descargar PDF
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% if report_data is defined %}
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-table"></i> {{ report_title }}</h5>
                <!-- Botones para descargar PDF y Excel del reporte -->
                {% if start_date is defined and end_date is defined %}
                <form action="{{ url_for('export_pdf') }}" method="POST" class="d-inline-block float-right">
                    <input type="hidden" name="start_date" value="{{ start_date }}">
                    <input type="hidden" name="end_date" value="{{ end_date }}">
                    {% if employee_id is defined %}
                        <input type="hidden" name="employee_id" value="{{ employee_id }}">
                    {% endif %}
                    <button type="submit" class="btn btn-danger btn-sm ml-2"><i class="fas fa-file-pdf"></i> Descargar PDF</button>
                </form>
                <form action="{{ url_for('export_excel') }}" method="POST" class="d-inline-block float-right mr-2">
                    <input type="hidden" name="start_date" value="{{ start_date }}">
                    <input type="hidden" name="end_date" value="{{ end_date }}">
                    {% if employee_id is defined %}
                        <input type="hidden" name="employee_id" value="{{ employee_id }}">
                    {% endif %}
                    <button type="submit" class="btn btn-success btn-sm ml-2"><i class="fas fa-file-excel"></i> Descargar Excel</button>
                </form>
                {% endif %}
            </div>
            <div class="card-body">
{% if report_data is not none and not report_data.empty %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="thead-dark">
                            <tr>
                                {% for column in report_data.columns %}
                                <th>{{ column }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for _, row in report_data.iterrows() %}
                            <tr>
                                {% for value in row %}
                                <td>{{ value }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    No hay datos disponibles para el período seleccionado.
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if charts is defined %}
<div class="row mt-4">
    {% for chart in charts %}
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h6>{{ chart.title }}</h6>
            </div>
            <div class="card-body text-center">
                <img src="data:image/png;base64,{{ chart.data }}" class="img-fluid" alt="{{ chart.title }}">
            </div>
        </div>
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}